# Vit/Vivit-StockPrediction

## 项目目录
My_ViT_Project/
├── models/
│   ├── __init__.py
│   ├── vit.py         <-- 从 GitHub 下载的模型定义文件
│   └── vivit.py       <-- 另一个仓库下载的 ViViT 文件
├── data/
│   └── dataset.py     <-- 你需要写的：将 Level 2 原始数据转为 15x8x8 张量
├── train.py           <-- 你需要写的：训练循环（包含 Loss, Optimizer）
└── evaluate.py        <-- 你需要写的：计算 RankIC 和回测指标

# Level-2 图像特征提取数据清单 (ViT/ViViT 复现专用)

本清单用于指引数据部门提取并清洗用于 **Vision Transformer (ViT)** 与 **Video Vision Transformer (ViViT)** 模型训练的 Level-2 逐笔数据。

---
## 数据结构

### 1. 原始数据提取要求 (Raw Data)

需提取回测期内（2017年至今）全市场个股的原始逐笔报文，并进行以下预处理。

| 数据类别 | 关键字段 (Fields) | 处理逻辑备注 |
| :--- | :--- | :--- |
| **逐笔成交 (Tick Execution)** | `Symbol`, `Time`, `Price`, `Qty`, `BS_Flag`, `Buy_ID`, `Sell_ID` | 需区分主动买入/主动卖出 (BS_Flag) |
| **逐笔委托 (Tick Order)** | `Symbol`, `Time`, `Price`, `Qty`, `Side`, `Order_Type` | 需区分限价单与市价单 |
| **交易所差异修正** | `Order_ID Tracking` | **上交所**需通过订单编号匹配识别撤单行为，对齐深交所规则 |
| **基准与标签** | `Daily_Return`, `Index_Return` | 计算个股相对于中证500/1000的未来10日超额收益 |

---

### 2. 图像通道定义 (15 Channels)

每个样本点需构造为一个 $15 \times 8 \times 8$ 的张量。通道（Channel）维度定义如下，每个像素点的值代表该区间内的**订单笔数**。

| 通道编号 | 通道分类 | 描述 (Pixel Value = 订单笔数/量) |
| :---: | :--- | :--- |
| **C1** | 成交-全部 | 所有成交的订单笔数 (不论方向、大小、主动被动) |
| **C2** | 成交-主动买入 | 以高于或等于卖一价成交的买入订单笔数 |
| **C3** | 成交-主动卖出 | 以低于或等于买一价成交的卖出订单笔数 |
| **C4** | 成交-大买单 | 成交金额大于阈值的主动买入订单笔数|
| **C5** | 成交-大卖单 | 成交金额大于阈值的主动卖出订单笔数 |
| **C6** | 成交-小买单 | 成交金额小于等于阈值的主动买入订单笔数 |
| **C7** | 成交-小卖单 | 成交金额小于等于阈值的主动卖出订单笔数 |
| **C8** | 委托-买单 | 新增加的限价买入委托订单笔数 |
| **C9** | 委托-卖单 | 新增加的限价卖出委托订单笔数 |
| **C10** | 委托-主动买入 | 本将挂在买盘的限价单，被主动成交（市价卖出打掉）的订单笔数 |
| **C11** | 委托-主动卖出 | 本将挂在卖盘的限价单，被主动成交（市价买入打掉）的订单笔数 |
| **C12** | 委托-非主动买入 | 新增并最终停留在买盘未被成交的限价买入订单笔数 |
| **C13** | 委托-非主动卖出 | 新增并最终停留在卖盘未被成交的限价卖出订单笔数 |
| **C14** | 委托-撤买 | 从买盘队列中撤销的买入订单笔数 |
| **C15** | 委托-撤卖 | 从卖盘队列中撤销的卖出订单笔数 |

---

### 3. 空间维度映射规则 (8x8 Grid)

图像的宽度（Width）和高度（Height）基于以下分位数规则进行离散化映射，形成空间分布特征：

| 维度 | 映射对象 | 划分逻辑 | 矩阵坐标 |
| :--- | :--- | :--- | :--- |
| **横轴 (W)** | **价格偏离度** | $(P_{tick} - P_{mid}) / P_{mid}$ 的 8 级分位数 | Index [0-7] |
| **纵轴 (H)** | **单笔量级** | 订单成交量/委托量的 8 级分位数 | Index [0-7] |

---

### 4. 模型输入维度对照 (Model Input)

模型输入需严格遵守以下 Tensor 形状限制：

| 模型 | 输入张量维度 (Shape) | 数据含义 |
| :--- | :--- | :--- |
| **ViT** | `(Batch, 15, 8, 8)` | 个股最新交易日的截面特征图像 |
| **ViViT** | `(Batch, 20, 15, 8, 8)` | 个股过去 20 个交易日的时序视频序列 |
| **Output** | `(Batch, 1)` | 预测未来 10 个交易日的累计超额收益率 |

---

### 5. 存储与归一化建议

* **存储格式**：推荐使用 `HDF5` (`.h5`) 或 `Parquet` 格式，以支持高频随机读取。
* **归一化**：建议在特征生成后进行全局或截面 Z-Score 标准化，处理极端离群值。
* **时间对齐**：输入图像的日期 $T$ 必须关联未来 $T+1$ 至 $T+10$ 的累计收益，严禁前瞻偏差。